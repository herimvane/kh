<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro" lang="zh">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
     <link href="/static/css/bootstrap.min.css?v=3.4.0" rel="stylesheet">
    <link href="/static/font-awesome/css/font-awesome.css?v=4.3.0" rel="stylesheet">
    <link rel="stylesheet" href="/static/jquery-bar-rating/themes/fontawesome-stars.css">
    <link href="/static/raty/jquery.raty.css" rel="stylesheet">
    <link href="/static/css/animate.css" rel="stylesheet">
    <link href="/static/css/style.css?v=2.2.0" rel="stylesheet">	

    <title>毕节银保监分局2020人事考核 - 考核</title>
    <meta name="keywords" content="毕节银保监分局">
    <meta name="description" content="人事考核">
    <style type="text/css">
    
	    .shadow {
			box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15)!important;
		}
		
		.navbar-user {
			float: right;
			height: 50px;
			padding: 15px 15px;
			font-size: 18px;
			line-height: 20px;
			margin-right: 20px;
		}
		
		.navbar-brand {
			margin-left: 20px;
		}
		.navbar-brand i {
			font-size: 20px;
			margin-right: 10px;
		}
		
		.navbar a {
			cursor: pointer;
			text-decoration: none;
			color: #676a6c;
		}
		
		.navbar-user i {
			font-size: 18px;
			margin-left: 10px;
		}
    	@media (max-width: 768px) {
    		.navbar-brand span {
    			display: none;
    		}
    		.navbar-brand em {
    			font-size: 12px;
    		}
    	}
    	
    	.dropdown-item {
			display: block;
			width: 100%;
			padding: .25rem 1.5rem;
			clear: both;
			font-weight: 400;
			color: #3a3b45;
			text-align: inherit;
			white-space: nowrap;
			background-color: transparent;
			border: 0;
		}
		
		.dropdown-menu {
			right: .75rem;
			left: auto;
		}
		
		.assessbody {
			padding: 20px;
			text-align: center;
		}
		.assessbody button {
			font-size: 18px;
		}
		.card-c {
			border: 1px solid #e3e6f0;
			border-radius: .35rem;
			border-left: .7rem solid #a64942!important;
			border-right: .7rem solid #a64942!important;
			width: 100% !important;
			padding-bottom: .5rem;
			padding-top: .5rem;
			margin-bottom: 10px;
			min-width: 150px;
			background-color: #293462 !important;
			border-radius: 15px;
			font-size: 1rem !important;
		}
    	.progress {
                height: 80px;
                width: 80px;
                margin: 50px auto;
                background-color: #f3f3f4;
            }

        .progress > svg {
            height: 100%;
            display: block;
        }
        
        .accordion {
        	color: #fff;
        }
        
        .accordion button:hover {
        	color: #FFFFF3 !important;
        }
        
        .card-header {
			padding: .75rem 1.25rem;
			margin-bottom: 0;
			background-color: #18a689;
			border-bottom: 1px solid rgba(0,0,0,.125);
		}
		
		.card {
			background-color: #f3f3f4;
			border: none;
		}
		
		.card-body {
			-ms-flex: 1 1 auto;
			flex: 1 1 auto;
			min-height: 1px;
			padding: 1.25rem;
		}
		.card-title {
			color: #ccff33;
		}
    </style>
  </head>
  <body style="background-color: #f3f3f4;">
  	<div>
	  	<nav class="navbar shadow">
		  <a class="navbar-brand"><i class="fa fa-file" aria-hidden="true"></i><span>毕节银保监分局度人事考核</span><i style="color: red;"></i><em>(按姓氏笔画排序)</em></a>
		  <div class="navbar-user dropdown">
			  <a class="dropdown-toggle" id="userdrop" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span th:text="${session.user.name}"></span><i class="fa fa-user" aria-hidden="true"></i>
			  </a>
			   <div class="dropdown-menu" aria-labelledby="userdrop">
				    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#pwdModalCenter"><i class="fa fa-pencil-square-o"></i>修改密码</a>
				    <a class="dropdown-item" href="/user/logout"><i class="fa fa-sign-out"></i>退出登陆</a>
			  </div>
			  <!-- pwd -->
			  <div class="modal fade" id="pwdModalCenter" tabindex="-1" role="dialog" aria-labelledby="pwdModalCenterTitle" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h3 class="modal-title" id="pwdModalCenterTitle">修改密码</h3>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body">
				      <form id="pwdform">
				        <div class="form-group">
	                     	<label>原密码</label>
	                     	<input type="password" placeholder="请输入原密码" class="form-control" name="oldpwd" id="oldpwd">
	                     </div>
	                      <div class="form-group">
	                     	<label>新密码</label>
	                     	<input type="password" placeholder="请输入新密码" class="form-control" name="newpwd" id="newpwd">
	                     </div>
	                  </form>
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
				        <button type="button" class="btn btn-primary" id="pwdupdate">修改</button>
				      </div>
				    </div>
				  </div>
				</div>
                 <!-- pwd -->
		  </div>
		</nav>
		<div class="assessbody container">
			<div th:if="${session.user.status == 0}">
					<div class="progress" id="progress"></div>
				<button type="button" class="btn btn-primary btn-lg btn-rounded" id="generateAssessment">生成考核任务</button>
			</div>
			<div class="accordion" id="assessaccordion" th:if="${session.user.status != 0}">
			  <div class="card" th:if="${not #lists.isEmpty(assessmentsa)}">
			    <div class="card-header" id="headingCharge">
			      <h2 class="mb-0">
			        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseCharge" aria-expanded="true" aria-controls="collapseCharge">
			          部门主要负责人考核<span th:if="${session.user.position.name !='其他干部'}" style="color: #ccff33;font-size: 15px;">(优秀可选2人)</span><i class="fa fa-chevron-down" aria-hidden="true"></i>
			        </button>
			      </h2>
			    </div>
			    <div id="collapseCharge" class="collapse" aria-labelledby="headingCharge" data-parent="#assessaccordion">
			      <div class="card-body">
					  <div class="row justify-content-center" id="arow">
				      	<div class="mycol col col-md-4" th:each="assessment : ${assessmentsa}">
					      	<div class="card card-c shadow" style="width: 18rem;">
								  <div class="card-body">
								    <h4 class="card-title" th:text="${assessment.user.name}"></h4>
								    <p class="card-text" th:text="${assessment.user.dept.name}"></p>
								   	<div class="raty" th:id="'raty_a_'+${assessment.id}" th:attr="data-score=${(assessment.score-65)/10 + 1}"></div>
									<span class="your-rating" th:id="'rating_a_'+${assessment.id}">
					                </span>
								  </div>
							</div>
				      	</div>
				      </div>
			    </div>
			  </div>
			  <div class="card" th:if="${not #lists.isEmpty(assessmentsb)}">
			    <div class="card-header" id="headingfk">
			      <h2 class="mb-0">
			        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapsefk" aria-expanded="false" aria-controls="collapsefk">
			          机关其他干部考核<i class="fa fa-chevron-down" aria-hidden="true"></i>
			        </button>
			      </h2>
			    </div>
			    <div id="collapsefk" class="collapse" aria-labelledby="headingfk" data-parent="#assessaccordion">
			      <div class="card-body">
			      <div class="row justify-content-center" id="brow">
			      	<div class="mycol col col-md-4" th:each="assessment : ${assessmentsb}">
				      	<div class="card card-c shadow" style="width: 18rem;">
							  <div class="card-body">
							    <p class="card-title" th:text="${assessment.user.name}"></p>
							    <p class="card-text" th:text="${assessment.user.dept.name}"></p>
							   	<div class="raty" th:id="'raty_b_'+${assessment.id}" th:attr="data-score=${(assessment.score-65)/10 + 1}"></div>
								<span class="your-rating" th:id="'rating_b_'+${assessment.id}">
				                </span>
							  </div>
						</div>
			      	</div>
			      </div>
			      </div>
			    </div>
			  </div>
			  <div class="card" th:if="${not #lists.isEmpty(assessmentsc)}">
			    <div class="card-header" id="headingky">
			      <h2 class="mb-0">
			        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseky" aria-expanded="false" aria-controls="collapseky">
			          监管组其他干部考核<i class="fa fa-chevron-down" aria-hidden="true"></i>
			        </button>
			      </h2>
			    </div>
			    <div id="collapseky" class="collapse" aria-labelledby="headingky" data-parent="#assessaccordion">
			      <div class="card-body">
				        <div class="row justify-content-center" id="crow">
				      	<div class="mycol col-12 col-md-4" th:each="assessment : ${assessmentsc}">
					      	<div class="card card-c shadow" style="width: 18rem;">
								  <div class="card-body">
								    <p class="card-title" th:text="${assessment.user.name}"></p>
								    <p class="card-text" th:text="${assessment.user.dept.name}"></p>
								   	<div class="raty" th:id="'raty_c_'+${assessment.id}" th:attr="data-score=${(assessment.score-65)/10 + 1}"></div>
									<span class="your-rating" th:id="'rating_c_'+${assessment.id}">
					                </span>
								  </div>
							</div>
				      	</div>
				      </div>
			      </div>
			    </div>
			  </div>
			</div>
			</div>
        </div>
  	</div>

    <script src="/static/js/jquery-2.1.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js?v=3.4.0"></script>
    <script src="/static/jquery-bar-rating/jquery.barrating.min.js"></script>
     <script src="/static/raty/jquery.raty.js"></script>
     <script src="/static/js/progressbar.min.js"></script>
     <script src="/static/js/plugins/validate/jquery.validate.min.js"></script>
    <script src="/static/js/plugins/validate/messages_zh.min.js"></script>
     
    
    <script type="text/javascript" th:inline="javascript">
	   $(function() {
	      $('#example').barrating({
	        theme: 'fontawesome-stars',
	        showValues: false,
	        showSelectedRating: true
	      });
	      
	      $('.collapse').on('show.bs.collapse', function () {
	    	 var i = $(this).prev().find('button i');
	    	 i.removeClass('fa-chevron-down');
	    	 i.addClass('fa-chevron-up');
	      })
	      $('.collapse').on('hide.bs.collapse', function () {
	    	 var i = $(this).prev().find('button i');
	    	 i.removeClass('fa-chevron-up');
	    	 i.addClass('fa-chevron-down');
	      })
	      
	      $("div[id^='raty']").each(function(index,element) {
	    	  var type = $(this).attr('id').split('_')[1];
	    	  var ratythis = $(this);
	    	  $(this).raty({
		    	  path: '/static/raty/images',
		          target : '#rating_' + $(this).attr('id').split('_')[1]+"_"+$(this).attr('id').split('_')[2],
		          number: 4,
		          hints:['不称职', '基本称职', '称职', '优秀'],
		          click: function(score, evt) {
		        	  //判断优秀人数
		        	  var select = ("#"+type+"row input[type='hidden']");
		        	  var selectv = ("#"+type+"row input[type='hidden'][value='4']");
		        	  var inputs = $(select).length;
		        	  var inputs4 = $(selectv).length;
		        	  //var inputs = $("#crow input[type='hidden']").length;
		        	  //var inputs4 = $("#crow input[type='hidden'][value='4']").length;
		        	  var ratio = Math.round(inputs*0.25) == 0 ? 1 : Math.round(inputs*0.25);
		        	  var thisOldScore = $(this).find("input[type='hidden']").get(0).value;
		        	  if(thisOldScore!=4 && score==4) inputs4+=1;
		        	  if(thisOldScore==4 && score!=4) inputs4-=1;
		        	  
		        	  if(type=="a") {//单独控制主要负责人
		        		  if(inputs4 > 2) {
			        		  alert("当前优秀人数不能超过：" + 2 + "个。");
			        		  ratythis.raty('score',thisOldScore);//解决移动端return false后不能还原的问题
			        		  return false;
			        	  }
		        	  }
		        	  if(inputs4 > ratio) {
		        		  alert("当前优秀人数不能超过：" + ratio + "个。");
		        		  ratythis.raty('score',thisOldScore);//解决移动端return false后不能还原的问题
		        		  return false;
		        	  }
		        	  var cr = this;
		        	  $.ajax({
		            		type: "POST",
		            		contentType: "application/json",
		            		url : "/user/rating",
		            		dataType : "json",
		            		data : JSON.stringify({
		            			"id" : cr.id.split('_')[2],
		            			"score" : (score-1) *10 + 65
		            		}),
		            		success: function(data) {
		            			if(data.code==1) alert(data.msg);
		            		}
		            	});
		        	  
	        	    //alert('ID: ' + this.id + "\nscore: " + score + "\nevent: " + evt);
	        	  }
		      });
	      }); 
	      /* 
	      $('.raty').raty({
	    	  path: '/static/raty/images',
	          target : '.your-rating',
	          number: 4,
	          hints:['不称职', '基本称职', '称职', '优秀']
	    	  
	      }); */
	      
	      $("#generateAssessment").click(function() {
		      $("#generateAssessment").html("生成任务中...");
		      $("#generateAssessment").addClass("disabled");
	    	//SemiCircle
		      //Line
		      var circle = new ProgressBar.Circle('#progress', {
		          color: '#1ab394',
		          duration: 3000,
		          strokeWidth: 4,
		          trailWidth: 1,
		          text: {
		              value: ''
		          },
		          easing: 'easeInOut',
		          step: function(state, circle, attachment) {
		        	  circle.setText(Math.round(circle.value()*100)+'%');
		        	  if(Math.round(circle.value()*100)==100) $("#generateAssessment").html("完成,即将跳转至登陆页面....");
		          }
		      });
	    	  $.ajax({
          		type: "GET",
          		contentType: "application/json",
          		url : "/user/generate/"+/*[[${session.user.id}]]*/"",
          		dataType : "json",
          		success: function(data) {
          			if(data.code==0) {
          					circle.animate(1);
          					setTimeout(function() {
		            			window.location.href=data.url;
          					},3500);
          			} else {
          			  $("#generateAssessment").html("生成考核任务");
          		      $("#generateAssessment").removeClass("disabled");
          				alert(data.msg);
          			}
          		}
          	});
	    	  
		     
	      });
	      
	      $("#pwdform").validate({
              rules: {
                  oldpwd: {
                	  required: true,
                      minlength: 8
                  },
                  newpwd: {
                	  required: true,
                      minlength: 8
                  },
              },
              messages: {
                  name: "请输入原密码",
                  password: "请输入新密码",
              }
          });
	      $("#pwdupdate").click(function() {
	    	  if($("#pwdform").valid()) {
		    	  $.ajax({
		          		type: "POST",
		                contentType : 'application/x-www-form-urlencoded',
		          		url : "/user/password",
		          		data: {
		          			"id": /*[[${session.user.id}]]*/"",
		          			"oldpwd": $("#oldpwd").val(),
		          			"newpwd": $("#newpwd").val()
		          		},
		          		success: function(data) {
		          			if(data.code==0) {
		          				window.location.href=data.url;
		          			} else {
		          				alert(data.msg);
		          			}
		          		}
		          	});
	    	  }
		      });
	      
	   });
	</script>
  </body>
</html>